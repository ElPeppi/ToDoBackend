service: todo-api
frameworkVersion: "3"

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  stage: prod
  
  environment:
    NODE_ENV: production
    DB_HOST: ${env:DB_HOST}
    DB_USER: ${env:DB_USER}
    DB_PASSWORD: ${env:DB_PASSWORD}
    DB_NAME: ${env:DB_NAME}
    DB_PORT: ${env:DB_PORT, "3306"}

    JWT_SECRET: ${env:JWT_SECRET}
    REFRESH_SECRET: ${env:REFRESH_SECRET}

    SMTP_HOST: ${env:SMTP_HOST}
    SMTP_PORT: ${env:SMTP_PORT, "587"}
    SMTP_USER: ${env:SMTP_USER}
    SMTP_PASS: ${env:SMTP_PASS}

    APP_URL: ${env:APP_URL}
  httpApi:
    cors:
      allowedOrigins:
        - http://localhost:5173
        - https://todo.jan-productions.com
      allowedHeaders:
        - Content-Type
        - Authorization
      allowedMethods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS

plugins:
  - serverless-esbuild

custom:
  esbuild:
    bundle: true
    platform: node
    target: node20
    format: cjs
    sourcemap: true
    # Si usas mysql2 y te da problemas al bundle, d√©jalo como external:
    external:
      - mysql2

functions:
  api:
    handler: src/lambda.handler
    events:
      - httpApi:
          path: /{proxy+}
          method: ANY
